<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>路線・駅選択</title>
<style>
* { margin: 0; padding: 0; }
html, body { width: 100%; height: 100%; overflow: hidden; }
iframe { width: 100%; height: 100%; border: none; }
</style>
<!-- LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<iframe id="gasFrame" src="about:blank" allow="forms"></iframe>
<script>
// LIFF ID
var LIFF_ID = '2009257618-mx8s5Vuk';

// GAS Web App URL（デプロイID固定）
var GAS_URL = 'https://script.google.com/macros/s/AKfycbxPj9FQfY09HdJPZ39Tku5O4brLjam-HOWwcdP3HL0AoJ2s6pRXJ0h3hPfsjQjBWqIU/exec';

// LIFF初期化
liff.init({ liffId: LIFF_ID }).catch(function(err) {
  console.log('LIFF init error:', err);
});

// GAS iframe からの完了通知を受信して LIFF ウィンドウを閉じる
window.addEventListener('message', function(event) {
  if (event.data === 'liff-close') {
    if (liff.isInClient()) {
      liff.closeWindow();
    } else {
      window.close();
    }
  }
});

// URLパラメータをそのままGASに転送
var params = window.location.search;

// LIFF経由の場合、liff.stateパラメータを展開
var urlParams = new URLSearchParams(params);
var liffState = urlParams.get('liff.state');
if (liffState) {
  // liff.stateの中身（?action=selectRoutes&userId=xxx）をGAS URLに付与
  var gasParams = liffState;
  if (!gasParams.startsWith('?')) gasParams = '?' + gasParams;
  document.getElementById('gasFrame').src = GAS_URL + gasParams;
} else if (params) {
  // 通常のパラメータをそのまま転送
  document.getElementById('gasFrame').src = GAS_URL + params;
} else {
  document.getElementById('gasFrame').src = GAS_URL;
}
</script>
</body>
</html>
